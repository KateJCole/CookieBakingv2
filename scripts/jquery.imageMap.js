/*! -- File: jquery.imageMap.js ( Input 0 ) -- */
!function(c){var e=function(a,b){this.el=c(a);this.preamble=c(a).find(".preamble");this.image=c(a).find("img");this.dotSize=30;this.enabled=!0;this.render();this.options=b;this.options.showLabels=this.el.hasClass("showLabels");this.initDB(b.outline);this.answers=[];this.setListeners();this.scaler=new e.Scaler(this.image,{onChange:c.proxy(this.onScaleChanged,this)});this.redraw=DKI.func.debounce(c.proxy(this.drawZones,this),250,!1);this.setDropZones();return this};e.DEFAULTS={accessible:!0,mapFillColour:"rgba(52,52,52,0.5)",
mapStrokeColour:"rgb(52,52,52)",numberZones:!1,autoPosition:!0,enableDraggable:!0,strings:{previous:"Previous",next:"Next",finish:"Finish",correct:"Correct",incorrect:"Incorrect"}};e.constant=Object.freeze({screenReader:{visible:{tabindex:"1","aria-hidden":"false"},hidden:{tabindex:"-1","aria-hidden":"true"}}});e.prototype={initDB:function(a){this.db=function(){var a={},b={dragdrop_id:{}};return{store:function(b){a[b.id]=b},get:function(b){return a[b]},getByKey:function(a,f){return b[a][f]},remove:function(b){delete a[item.id]},
clear:function(){a={}},getLength:function(){return Object.keys(a).length}}}();var b=c.proxy(function(a){this.db.store(a);for(var c in a.elements)b(a.elements[c])},this);b(a)},render:function(){this.container=c('\x3cdiv class\x3d"dki-marker-container" style\x3d"position:absolute;z-index:1"\x3e\x3c/div\x3e').appendTo(this.image.parent());this.container.parent().css("position","relative")},setListeners:function(){var a=this;this.preamble.find("button").on("click",function(){a.preamble.addClass("hide")});
if(this.options.showLabels){var a=this,b=function(){var b=DKI.utility.getScale();c(".imagemap-label",a.el).draggable("option","containment",DKI.utility.getDragContainment(c(a.el),a.dotSize,a.dotSize));c(".imagemap-label",a.el).draggable("option","cursorAt",{left:a.dotSize*b/2,top:a.dotSize*b/2})};c(window).on("resize",function(){a.options.enableDraggable&&b()});if("undefined"!=typeof DKI&&"undefined"!=typeof DKI.ContentPage&&"undefined"!=typeof DKI.ContentPage.events)c(document).on(DKI.ContentPage.events.started,
function(){setTimeout(function(){b()},20)});c(".imagemap-label",this.el).draggable({helper:function(a,b,m,g){return c(this).find(".imagemap-label-dot").clone().css("margin","0")},revert:"invalid",containment:DKI.utility.getDragContainment(c(a.el),a.dotSize,a.dotSize),revertDuration:0,stack:this.el,scroll:"undefined"!=typeof settings?settings.responsive:c("html").hasClass("responsive"),zIndex:1E5,disabled:!1,start:function(){a.container.droppable("enable")},drag:function(a,b){DKI.utility.dragFix(b)},
stop:function(b,c){c.helper.remove();a.container.droppable("disable")},cursorAt:{left:a.dotSize/2,top:a.dotSize/2}});this.container.droppable({accept:".imagemap-label",disabled:!0,drop:function(b,c){b=c.helper.data("id");var m=DKI.utility.getScale();if(a.enabled){var g=a.container.offset();g.top/=m;g.left/=m;c.offset.top/=m;c.offset.left/=m;a.addAnswer({coords:[c.offset.left-g.left+a.dotSize*m/2,c.offset.top-g.top+a.dotSize*m/2],correctZoneId:b})}a.el.find(".imagemap-label-wrapper .imagemap-label[data-id\x3d"+
b+"]").draggable("disable")}})}else this.container.on("click",function(b){a.enabled&&a.addAnswer({coords:[b.offsetX,b.offsetY]})})},addAnswer:function(a){var b=this,c={correctZoneId:a.correctZoneId,helper:a.helper,idx:this.answers.length,imageMap:this,coords:a.coords,listeners:{destroy:function(){b.answers.splice(this.idx,1);b.options.showLabels&&b.el.find(".imagemap-label-wrapper .imagemap-label[data-id\x3d"+a.correctZoneId+"]").draggable("enable")}}};answer=this.options.showLabels?new e.LabelAnswer(c):
new e.Answer(c);this.answers.push(answer)},enable:function(){c.each(this.answers,function(){this.enable()});this.enabled=!0},disable:function(){c.each(this.answers,function(){this.disable()});this.enabled=!1},onScaleChanged:function(){c.each(this.answers,function(){this.reposition()});this.redraw()},setDropZones:function(){this.dropZones=this.options.outline.elements.map(function(a){var b=a.parameters.config.map;return{id:a.id,shape:b.shape,coords:b.coords,distractor:b.distractor||!1}})},reset:function(){for(;this.answers.length;)this.answers.pop().destroy();
this.el.find(".imagemap-label").removeClass("correct incorrect");this.canvas&&(this.canvas.remove(),this.canvas=null);this.preamble.removeClass("hide")},destroy:function(){this.scaler.destroy();this.container.remove();this.reset()},score:function(){var a=0,b=Math.max(this.answers.length,this.dropZones.filter(function(a){return!a.distractor}).length),f=this.answers.concat([]),d=this;c.each(this.dropZones,function(){for(var c=!1,g=this,e=function(f,d){d.correct=null===d.correctZoneId?!g.distractor:
!g.distractor&&g.id==d.correctZoneId;d.zone=g.id;a+=d.correct?1:0;b-=c?1:0;c=null===d.correctZoneId},k=f.length-1;0<=k;k--)switch(this.shape){case "poly":d.pointInPoly(d.scaler.parsePoly(this.coords),d.scaler.toScaled(f[k].coords))&&e(k,f[k]);break;case "circle":d.pointInCircle(d.scaler.parseCircle(this.coords).split(","),d.scaler.toScaled(f[k].coords))&&e(k,f[k]);break;case "rect":var h=d.scaler.parsePoly(this.coords);d.pointInPoly([[h[0][0],h[0][1]],[h[0][0],h[1][1]],[h[1][0],h[1][1]],[h[1][0],
h[0][1]]],d.scaler.toScaled(f[k].coords))&&e(k,f[k])}});return Math.max(a,0)/b*100},pointInPoly:function(a,b){var c=b[0];b=b[1];for(var d=!1,e=0,g=a.length-1;e<a.length;g=e++){var p=a[e][0],k=a[e][1],h=a[g][0],g=a[g][1];k>b!=g>b&&c<(h-p)*(b-k)/(g-k)+p&&(d=!d)}return d},pointInCircle:function(a,b){return Math.pow(b[0]-a[0],2)+Math.pow(b[1]-a[1],2)<=Math.pow(a[2],2)},drawZones:function(a){if(this.canvas){var b=this.canvas[0].getContext("2d");b.canvas.width=this.image.width();b.canvas.height=this.image.height();
this.canvas.width();this.canvas.height();b.clearRect(0,0,this.canvas.width,this.canvas.height);var f=this,d=a?this.getAnswersByZone():null;c.each(this.dropZones,function(a,g){var e=this;if(!d||d[this.id].length){var k="incorrect";e.distractor?(k="correct",c.each(f.answers,function(){this.zone==e.id&&(k="incorrect")})):c.each(f.answers,function(){this.zone==e.id&&this.correct&&(k="correct")});g="string"===typeof f.options.mapStrokeColour?f.options.mapStrokeColour:f.options.mapStrokeColour[k];b.fillStyle=
"string"===typeof f.options.mapFillColour?f.options.mapFillColour:f.options.mapFillColour[k];b.lineWidth=3;b.strokeStyle=g;b.beginPath();switch(this.shape){case "poly":var h=f.scaler.parsePoly(this.coords),n=h[0],l=[[n[0],n[1]],[n[0],n[1]]];b.moveTo(n[0],n[1]);c.each(h,function(){b.lineTo(this[0],this[1]);this[0]<l[0][0]?l[0][0]=this[0]:this[0]>l[1][0]&&(l[1][0]=this[0]);this[1]<l[0][1]?l[0][1]=this[1]:this[1]>l[1][1]&&(l[1][1]=this[1])});b.closePath();break;case "rect":l=f.scaler.parsePoly(this.coords);
b.rect(l[0][0],l[0][1],l[1][0]-l[0][0],l[1][1]-l[0][1]);break;case "circle":h=f.scaler.parseCircle(this.coords).split(",").map(function(a){return parseInt(a,10)}),l=[[h[0]+h[2]*Math.cos(180),h[1]+h[2]*Math.sin(180)],[h[0]+h[2]*Math.cos(315),h[1]+h[2]*Math.sin(315)]],b.arc(h[0],h[1],h[2],0,2*Math.PI,!1)}b.fill();b.stroke();f.options.numberZones&&(b.fillStyle=g,b.beginPath(),g=[l[0][0]-4,l[0][1]-4],0>g[0]-8&&(g[0]=l[1][0]+4),0>g[1]-8&&(g[1]=l[1][1]+4),b.arc(g[0],g[1],8,0,2*Math.PI,!1),b.fill(),b.lineWidth=
1,b.strokeStyle="#FFF",b.stroke(),b.font="11px Open Sans",b.fillStyle="#fff",b.textAlign="center",b.textBaseline="middle",b.fillText(a+1,g[0],g[1]+1))}})}},getAnswersByZone:function(){var a=this.dropZones.reduce(function(a,c){a[c.id]=[];return a},{distractor:[]});c.each(this.answers,function(){a[this.zone||"distractor"].push(this)});return a},enterReview:function(a,b,f){var d=this;c(".ui-draggable",this.$el).draggable("disable");c.each(this.answers,function(){this.showState()});this.canvas&&this.canvas.remove();
this.canvas=c('\x3ccanvas style\x3d"position:absolute; left:0; z-index:2;" /\x3e').appendTo(this.image.parent());a&&this.drawZones(b);f&&this.el.find(".imagemap-label:not(.correct):not(.incorrect)").each(function(){var a=d.db.get(c(this).data("id"));"undefined"!=typeof a.parameters.config.map.distractor&&a.parameters.config.map.distractor?c(this).addClass("correct"):c(this).addClass("incorrect")})},exitReview:function(){c(".ui-draggable",this.$el).draggable("enable");c.each(this.answers,function(){this.hideState()});
this.inlineFeedback&&(this.inlineFeedback.destroy(),this.inlineFeedback=null);this.canvas.remove();this.canvas=null;this.el.find(".correct, .incorrect").removeClass("incorrect correct")},hasInlineFeedback:function(){var a=!1,b=this;c.each(this.getAnswersByZone(),function(c,d){if("distractor"!==c&&this.length&&""!==b.db.get(c).txt)return a=!0,!1});return a},showInlineFeedback:function(a,b){var f=[],d=this;c.each(this.getAnswersByZone(),function(a,c){"distractor"===a||!this.length||b&&""===d.db.get(a).txt||
f.push({answer:this[0],outline:d.db.get(a)})});this.inlineFeedback&&this.inlineFeedback.destroy();f.length&&(this.inlineFeedback=new e.Answer.Feedback(f,a),this.inlineFeedback.show())},export:function(){return this.answers.map(function(a){return a.export()})},import:function(a){var b=this;c.each(a,function(){b.addAnswer(this)})},resize:function(){this.scaler.setScale()},hasSelection:function(){return this.answers.length?!0:!1}};c.fn.ImageMap=function(a){var b=a,f=Array.prototype.slice.call(arguments,
1);return this.each(function(){var d=c(this),m=c(this).data("dki.ImageMap");options=c.extend(!0,{},e.DEFAULTS,"object"===typeof b&&b);if("string"===typeof a&&!m)return!1;m?"string"===typeof a&&(d=c(this).data("dki.ImageMap"))&&d[a]&&d[a].apply(c(this).data("dki.ImageMap"),f):d.data("dki.ImageMap",new e(this,options))})};c.fn.ImageMap.Constructor=e;e.Answer=function(a){DKI.apply(this,DKI.applyIf(a,{listeners:{destroy:function(){}},coords:[0,0],correctZoneId:null,helper:null,correct:!1},!0));this.dotSize=
30;this.enabled=!0;this.coords=this.coords.natural?this.coords.natural:this.imageMap.scaler.toNatural(this.coords);this.helper=a.helper;this.render();this.setListeners();this.reposition();return this};e.Answer.prototype={render:function(){this.marker=c(e.Answer.templates.marker({}));this.imageMap.container.append(this.marker);this.dims={pinRect:this.marker[0].getBoundingClientRect(),markerRect:this.marker.find(".marker")[0].getBoundingClientRect()}},setListeners:function(){var a=this;c(window).on("resize",
function(){a.marker.draggable("option","containment",DKI.utility.getDragContainment(c(a.imageMap.container),a.dotSize,a.dotSize))});this.marker.draggable({containment:DKI.utility.getDragContainment(c(a.imageMap.container),a.dotSize,a.dotSize),distance:5,drag:function(a,c){DKI.utility.dragFix(c)},stop:function(b,c){a.coords=a.imageMap.scaler.toNatural([c.position.left,c.position.top])}});this.marker.on("click",function(){a.enabled&&a.destroy();return!1})},enable:function(){this.enabled=!0;this.marker.draggable("enable")},
disable:function(){this.enabled=!1;this.marker.draggable("disable")},reposition:function(){var a=this.imageMap.scaler.toScaled(this.coords);this.marker.css({left:a[0]-this.dims.pinRect.width/2,top:a[1]-(this.dims.markerRect.height-(this.dims.markerRect.height-this.dims.pinRect.height)/2)})},showState:function(){this.marker.find(".fa").removeClass("fa-times fa-check fa-circle incorrect correct").addClass(this.correct?"fa-check correct":"fa-times incorrect")},hideState:function(){this.marker.find(".fa").removeClass("fa-times fa-check incorrect correct").addClass("fa-circle")},
export:function(){return{coords:{natural:this.coords}}},showFeedback:function(a,b){this.marker.tooltipster({content:e.Answer.templates.feedback(a),position:"left",contentAsHTML:!0,minWidth:200,trigger:"custom",arrow:!0,theme:"tooltipster-capture",interactive:!0,zIndex:100030,functionReady:function(a,d){b(c(d.tooltip).find(".tooltipster-content"))}}).tooltipster("show")},hideFeedback:function(a){this.marker.hasClass("tooltipstered")&&this.marker.tooltipster("destroy");a&&a()},destroy:function(){this.hideFeedback();
this.listeners.destroy.call(this);this.marker.remove()}};e.LabelAnswer=function(a){DKI.apply(this,DKI.applyIf(a,{listeners:{destroy:function(){}},coords:[0,0],correctZoneId:null,correct:!1},!0));this.dotSize=30;this.correctZoneId=a.correctZoneId;this.label=c(".imagemap-label[data-id\x3d"+this.correctZoneId+"]");this.enabled=!0;this.coords=this.coords.natural?this.coords.natural:this.imageMap.scaler.toNatural(this.coords);this.render();this.setListeners();this.reposition();return this};c.extend(e.LabelAnswer.prototype,
e.Answer.prototype,{render:function(){this.marker=this.label.find(".imagemap-label-dot").clone();this.imageMap.container.append(this.marker);this.dims={pinRect:this.marker[0].getBoundingClientRect()}},reposition:function(){var a=this.imageMap.scaler.toScaled(this.coords);this.marker.css({left:a[0]-this.dims.pinRect.width/2,top:a[1]-this.dims.pinRect.height/2})},showState:function(){this.marker.removeClass("incorrect correct").addClass(this.correct?"correct":"incorrect");this.label.removeClass("incorrect correct").addClass(this.correct?
"correct":"incorrect")},hideState:function(){this.marker.removeClass("incorrect correct");this.label.removeClass("incorrect correct")},export:function(){return{coords:{natural:this.coords},correctZoneId:this.correctZoneId}},destroy:function(){this.hideState();e.Answer.prototype.destroy.call(this)}});e.Answer.templates={marker:Handlebars.compile("\x3cdiv class\x3d'markerContainer' style\x3d' position:absolute;top:{{y}}px;left:{{x}}px'\x3e\x3ci class\x3d'marker pin fa fa-circle'\x3e\x3c/i\x3e\x3c/div\x3e"),
feedback:Handlebars.compile("\x3cdiv class\x3d'testMeFeedback'\x3e\x3ch4\x3e\x3ci class\x3d'fa {{#if correct}}fa-check{{else}}fa-times{{/if}} label-circle'\x3e\x3c/i\x3e\x3cspan\x3e{{title}}\x3c/span\x3e\x3c/h4\x3e\x3cdiv class\x3d'header'\x3e{{idx}}. {{elTitle}}\x3c/div\x3e\x3cdiv\x3e{{{feedback}}}\x3c/div\x3e\x3cdiv class\x3d'controls flex justify-between'\x3e{{#each buttons}}\x3cdiv class\x3d'{{cls}}' style\x3d'float:none;'\x3e{{label}}\x3c/div\x3e{{/each}}\x3c/div\x3e\x3c/div\x3e")};e.Answer.Feedback=
function(a,b){this.hotspotList=a;this.index=0;this.current=this.hotspotList[this.index];if(b)c(this).on("done",c.proxy(b,this));return this};e.Answer.Feedback.prototype={next:function(a){if(this.index+a===this.hotspotList.length)this.hide(),this.index=0,this.current=this.hotspotList[this.index],c(this).trigger("done");else{var b=this.current,f=this;this.index=Math.max(this.index+a,0);this.current=this.hotspotList[this.index];b.answer.hideFeedback(function(){f.show()})}},setButtonHandlers:function(a){var b=
this;a.off("click").on("click",".next,.prev",function(){b.next(c(this).hasClass("next")?1:-1)})},show:function(){if(this.current&&this.current.answer){var a=this;this.current.answer.showFeedback({idx:this.index+1,elTitle:this.current.outline.title,feedback:this.current.outline.txt,title:this.current.answer.imageMap.options.strings[this.current.answer.correct?"correct":"incorrect"],correct:this.current.answer.correct,buttons:[0!==this.index?{label:this.current.answer.imageMap.options.strings.previous,
cls:"prev"}:{},{label:this.index>=this.hotspotList.length-1?this.current.answer.imageMap.options.strings.finish:this.current.answer.imageMap.options.strings.next,cls:"next"}]},function(b){a.setButtonHandlers(b)})}},hide:function(){this.current.answer.hideFeedback()},destroy:function(){this.hide()}};e.Scaler=function(a,b){this.image=a;this.options=DKI.applyIf(b,{onChange:function(){}});this.scale=[0,0];this.setScale(!0);var f=this;this.onWindowResize=DKI.func.debounce(function(){f.setScale.call(f)},
50,!1);c(window).on("resize",this.onWindowResize);return this};e.Scaler.prototype={setScale:function(a){var b=[this.image.width()/this.image[0].naturalWidth,this.image.height()/this.image[0].naturalHeight];if(b[0]!=this.scale[0]||b[1]!==this.scale[1])if(this.scale=b,!a)this.options.onChange()},toScaled:function(a){var b=this;return a.map(function(a,c){return a*b.scale[c]})},toNatural:function(a){var b=this;return a.map(function(a,c){return 1/b.scale[c]*a})},destroy:function(){c(window).off("resize",
this.onWindowResize)},parsePoly:function(a){var b=[],c=0,d=[];for(a=a.split(",");0<a.length;)d.push(a.shift()),c%2&&(b.push(this.toScaled(d)),d=[]),c+=1;return b},parseCircle:function(a){a=a.split(",");return this.toScaled(a.slice(0,2)).concat(a[2]*this.scale[0]).join(",")}}}(window.jQuery);